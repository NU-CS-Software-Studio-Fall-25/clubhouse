<section class="container py-4">

  <div class="row justify-content-center">
    <div class="col-md-8">
      <article class="card shadow-sm">
        <div class="card-body">
          <h1 class="h3 fw-bold mb-3"><%= @event.name %></h1>

          <p class="text-muted mb-2">
            <i class="bi bi-clock me-1"></i>
            <strong>Date:</strong>
            <%= @event.date.strftime("%B %d, %Y at %I:%M %p") if @event.date %>
          </p>

          <% if @event.location.present? %>
            <p class="text-muted mb-2">
              <i class="bi bi-geo-alt me-1"></i>
              <strong>Location:</strong>
              <%= @event.location %>
            </p>
          <% end %>

          <p class="text-muted mb-2">
            <i class="bi bi-file-text me-1"></i>
            <strong>Description:</strong>
            <% if @event.description.present? %>
              <%= simple_format(@event.description) %>
            <% else %>
              <em>No description given for this event</em>
            <% end %>
          </p>
        </div>
        <div class="card-footer bg-white">
          <div class="d-flex gap-2">

            <%= link_to @event.club, class: "btn btn-outline-secondary" do %>
              <i class="bi bi-arrow-left me-1"></i> Back to club
            <% end %>
            <%= link_to edit_event_path(@event), class: "btn btn-outline-warning" do %>
              <i class="bi bi-pencil-fill me-1"></i> Edit
            <% end %>

            

            <%= button_to "Destroy this event", @event, method: :delete, data: { confirm: "Are you sure?" }, class: "btn btn-danger ms-auto" %>
          </div>
        </div>
      </article>

      <section class="card shadow-sm mt-4 mb-5">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h2 class="h3 mb-0 d-flex align-items-center">
            <i class="bi bi-people me-2"></i>
            Attendees (<%= @event.users_attending.length %>)
          </h2>

          <% if current_user.nil? %>
            <%= link_to "Sign in to RSVP",
                    signin_path,
                    class: "btn btn-primary" %>

          <% elsif !@event.user_attending?(current_user) %>
            <%= button_to "RSVP",
                    rsvp_event_path(@event),
                    method: :post,
                    class: "btn btn-success" %>

          <% else %>
            <%= button_to "Un-RSVP",
                    unrsvp_event_path(@event),
                    method: :delete,
                    class: "btn btn-danger" %>
          <% end %>

        </div>

        <div class="card-body w-100">
          <% if @event.users_attending.any? %>
            <div class="row g-2 ">
              <% @event.users_attending.each do |user_id| %>
                <% user = User.find_by(id: user_id) %>
                <% if user %>
                  <div class="col-sm-6 col-md-4">
                    <div class="card h-100">
                      <div class="card-body d-flex align-items-center gap-2">
                        <i class="bi bi-person-circle" style="font-size: 1.6rem;"></i>
                        <span class="fw-medium text-nowrap"><%= user.name %></span>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% end %>
            </div>

          <% else %>
            <p class="text-muted mb-0">No one has RSVPd to this event yet.</p>
          <% end %>

        </div>

      </section>
    </div>
  </div>

  <% if @auto_rsvp %>
    <form id="auto-rsvp" action="<%= rsvp_event_path(@event) %>" method="post" style="display:none;">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
    </form>

    <script>
        document.getElementById("auto-rsvp").submit();
    </script>
  <% end %>

  <div id="icsModal" class="modal-backdrop" style="display: none;">
    <div class="modal-box">
        <h3>Add to Your Calendar?</h3>
        <p>This event has been added to your RSVPs. Would you like to download an ICS file to add it to your calendar?</p>

        <div class="modal-actions">
        <a href="<%= download_ics_event_path(@event) %>" class="btn btn-primary">Download ICS</a>
        <button id="closeIcsModal" class="btn btn-secondary">No Thanks</button>
        </div>
    </div>
   </div>

  <script>
    (function() {
      try {
        var urlParams = new URLSearchParams(window.location.search || '');
        var show = urlParams.get('show_ics_modal');
        var modal = document.getElementById('icsModal');
        var closeBtn = document.getElementById('closeIcsModal');
        var downloadLink = modal && modal.querySelector('a[href]');

        function hideAndClean() {
          if (modal) modal.style.display = 'none';
          var base = window.location.href.split('?')[0];
          try { window.history.replaceState({}, document.title, base); } catch(e) { /* noop */ }
        }

        if (show && modal) {
          modal.style.display = 'flex';
        }

        if (closeBtn) {
          closeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            hideAndClean();
          });
        }

        if (downloadLink) {
          // When user clicks download, close the modal so the response can trigger the download cleanly.
          downloadLink.addEventListener('click', function() {
            if (modal) modal.style.display = 'none';
          });
        }
      } catch (err) {
        console && console.error && console.error('ICS modal init error:', err);
      }
    })();
  </script>



</section>
